{"version":3,"sources":["../../src/frameworks/tunnel.ts"],"sourcesContent":["/**\n * Shared Tunnel Logic for Framework Integrations\n *\n * Provides a simple API to start/stop tunnels from framework plugins.\n */\n\nimport { spawn, execSync, ChildProcess } from \"child_process\";\nimport Conf from \"conf\";\nimport clipboard from \"clipboardy\";\nimport qrcode from \"qrcode-terminal\";\n\nconst config = new Conf({\n  projectName: \"beam\",\n  schema: {\n    email: { type: \"string\" },\n    sessionToken: { type: \"string\" },\n    apiUrl: { type: \"string\", default: \"https://beam.byronwade.com\" },\n  },\n});\n\nconst API_URL = (config.get(\"apiUrl\") as string) || \"https://beam.byronwade.com\";\n\nexport interface TunnelOptions {\n  port: number;\n  subdomain?: string;\n  inspect?: boolean;\n  auth?: string;\n  copyToClipboard?: boolean;\n  qr?: boolean;\n  webhook?: boolean;\n  name?: string;\n  framework?: string;\n}\n\nexport interface TunnelInfo {\n  id: string;\n  url: string;\n  port: number;\n  inspectorUrl?: string;\n  dashboardUrl?: string;\n  isTracked: boolean;\n}\n\ninterface ActiveTunnel {\n  id: string;\n  process: ChildProcess;\n  url: string;\n  port: number;\n}\n\nconst activeTunnels = new Map<string, ActiveTunnel>();\n\n/**\n * Check if cloudflared is installed\n */\nfunction checkCloudflared(): boolean {\n  try {\n    execSync(\"cloudflared --version\", { stdio: \"pipe\" });\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Get current login status\n */\nfunction getLoginStatus(): { email: string; token: string } | null {\n  const email = config.get(\"email\") as string;\n  const token = config.get(\"sessionToken\") as string;\n\n  if (!email || !token) {\n    return null;\n  }\n\n  return { email, token };\n}\n\n/**\n * Start a tunnel\n */\nexport async function startTunnel(options: TunnelOptions): Promise<TunnelInfo> {\n  // Check cloudflared\n  if (!checkCloudflared()) {\n    throw new Error(\n      \"cloudflared is not installed. Install it first:\\n\" +\n        \"  macOS: brew install cloudflared\\n\" +\n        \"  Other: https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/get-started/create-local-tunnel/\"\n    );\n  }\n\n  const auth = getLoginStatus();\n  const isTracked = auth !== null;\n\n  // Generate tunnel ID\n  const tunnelId = `${options.framework || \"beam\"}-${options.port}-${Date.now()}`;\n\n  // Start cloudflared process\n  const args = [\"tunnel\", \"--url\", `http://localhost:${options.port}`];\n\n  const cloudflaredProcess = spawn(\"cloudflared\", args, {\n    stdio: [\"pipe\", \"pipe\", \"pipe\"],\n  });\n\n  // Wait for tunnel URL\n  const tunnelUrl = await new Promise<string>((resolve, reject) => {\n    let output = \"\";\n    const timeout = setTimeout(() => {\n      reject(new Error(\"Timeout waiting for tunnel URL\"));\n    }, 30000);\n\n    const handleOutput = (data: Buffer) => {\n      output += data.toString();\n      const match = output.match(/https:\\/\\/[a-z0-9-]+\\.trycloudflare\\.com/);\n      if (match) {\n        clearTimeout(timeout);\n        resolve(match[0]);\n      }\n    };\n\n    cloudflaredProcess.stdout?.on(\"data\", handleOutput);\n    cloudflaredProcess.stderr?.on(\"data\", handleOutput);\n\n    cloudflaredProcess.on(\"error\", (err) => {\n      clearTimeout(timeout);\n      reject(err);\n    });\n\n    cloudflaredProcess.on(\"exit\", (code) => {\n      if (code !== 0 && !output.includes(\"trycloudflare.com\")) {\n        clearTimeout(timeout);\n        reject(new Error(`cloudflared exited with code ${code}`));\n      }\n    });\n  });\n\n  // Store active tunnel\n  activeTunnels.set(tunnelId, {\n    id: tunnelId,\n    process: cloudflaredProcess,\n    url: tunnelUrl,\n    port: options.port,\n  });\n\n  // Register with API if logged in\n  let dashboardUrl: string | undefined;\n  if (isTracked && auth) {\n    try {\n      const response = await fetch(`${API_URL}/api/tunnels`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${auth.token}`,\n        },\n        body: JSON.stringify({\n          name: options.name || `${options.framework}-${options.port}`,\n          port: options.port,\n          type: \"quick\",\n          quickTunnelUrl: tunnelUrl,\n          framework: options.framework,\n        }),\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        dashboardUrl = `${API_URL}/dashboard/tunnels/${data.tunnelId}`;\n      }\n    } catch {\n      // Silently fail API registration\n    }\n  }\n\n  // Copy to clipboard if requested\n  if (options.copyToClipboard) {\n    try {\n      await clipboard.write(tunnelUrl);\n      console.log(\"  \\u2713 Tunnel URL copied to clipboard\");\n    } catch {\n      // Clipboard might not be available\n    }\n  }\n\n  // Show QR code if requested\n  if (options.qr) {\n    console.log(\"\");\n    qrcode.generate(tunnelUrl, { small: true });\n    console.log(\"  Scan to open on mobile\");\n    console.log(\"\");\n  }\n\n  return {\n    id: tunnelId,\n    url: tunnelUrl,\n    port: options.port,\n    inspectorUrl: options.inspect ? \"http://localhost:4040\" : undefined,\n    dashboardUrl,\n    isTracked,\n  };\n}\n\n/**\n * Stop a tunnel by ID\n */\nexport async function stopTunnel(tunnelId: string): Promise<void> {\n  const tunnel = activeTunnels.get(tunnelId);\n  if (tunnel) {\n    tunnel.process.kill(\"SIGTERM\");\n    activeTunnels.delete(tunnelId);\n  }\n}\n\n/**\n * Stop all active tunnels\n */\nexport async function stopAllTunnels(): Promise<void> {\n  for (const [id] of activeTunnels) {\n    await stopTunnel(id);\n  }\n}\n\n/**\n * Get all active tunnels\n */\nexport function getActiveTunnels(): TunnelInfo[] {\n  return Array.from(activeTunnels.values()).map((t) => ({\n    id: t.id,\n    url: t.url,\n    port: t.port,\n    isTracked: false,\n  }));\n}\n"],"mappings":"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","names":[]}
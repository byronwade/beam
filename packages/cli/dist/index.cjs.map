{"version":3,"sources":["../src/index.ts"],"sourcesContent":["#!/usr/bin/env node\nimport { Command } from \"commander\";\nimport { spawn } from \"child_process\";\nimport fs from \"fs\";\nimport os from \"os\";\nimport path from \"path\";\n\nconst CONFIG_DIR = path.join(os.homedir(), \".beam\");\nconst CONFIG_PATH = path.join(CONFIG_DIR, \"credentials.json\");\n\n// Helper to find project root (look for package.json or go up from current dir)\nfunction findProjectRoot(): string {\n  let current = process.cwd();\n  while (current !== path.dirname(current)) {\n    if (fs.existsSync(path.join(current, \"package.json\"))) {\n      const pkg = JSON.parse(fs.readFileSync(path.join(current, \"package.json\"), \"utf8\"));\n      if (pkg.name === \"@beam/cli\" || fs.existsSync(path.join(current, \"packages\", \"tunnel-daemon\"))) {\n        return current;\n      }\n    }\n    current = path.dirname(current);\n  }\n  return process.cwd();\n}\n\nconst PROJECT_ROOT = findProjectRoot();\nconst TUNNEL_DAEMON_PATH = path.join(PROJECT_ROOT, \"packages/tunnel-daemon/target/release/beam-tunnel-daemon\");\n\nfunction saveToken(token: string) {\n  fs.mkdirSync(CONFIG_DIR, { recursive: true });\n  fs.writeFileSync(CONFIG_PATH, JSON.stringify({ token }, null, 2));\n  console.log(`Saved token to ${CONFIG_PATH}`);\n}\n\nfunction loadToken(): string | null {\n  if (!fs.existsSync(CONFIG_PATH)) return null;\n  try {\n    const data = JSON.parse(fs.readFileSync(CONFIG_PATH, \"utf8\"));\n    return data.token || null;\n  } catch {\n    return null;\n  }\n}\n\nfunction checkTunnelDaemon(): boolean {\n  try {\n    return fs.existsSync(TUNNEL_DAEMON_PATH);\n  } catch {\n    return false;\n  }\n}\n\nfunction buildTunnelDaemon(): Promise<void> {\n  return new Promise((resolve, reject) => {\n    console.log(\"Building tunnel daemon...\");\n\n    const tunnelDaemonDir = path.join(PROJECT_ROOT, \"packages/tunnel-daemon\");\n    const cargo = spawn(\"cargo\", [\"build\", \"--release\"], {\n      cwd: tunnelDaemonDir,\n      stdio: \"inherit\"\n    });\n\n    cargo.on(\"close\", (code) => {\n      if (code === 0) {\n        console.log(\"‚úÖ Tunnel daemon built successfully\");\n        resolve();\n      } else {\n        reject(new Error(`Cargo build failed with code ${code}`));\n      }\n    });\n\n    cargo.on(\"error\", reject);\n  });\n}\n\nasync function startTunnelDaemon(port: number, options: any): Promise<void> {\n  // Check if daemon exists, build if needed\n  if (!checkTunnelDaemon()) {\n    console.log(\"üî® Tunnel daemon not found, building...\");\n    try {\n      await buildTunnelDaemon();\n    } catch (error: any) {\n      console.error(\"‚ùå Failed to build tunnel daemon:\", error.message);\n      console.log(\"üí° Make sure Rust is installed: https://rustup.rs/\");\n      process.exit(1);\n    }\n  }\n\n  // Build daemon arguments\n  const args = [\n    \"--port\", port.toString(),\n    \"--domain\", options.domain || `beam-tunnel-${Date.now()}.local`\n  ];\n\n  if (options.dual) {\n    args.push(\"--dual\");\n  }\n\n  if (options.tor) {\n    args.push(\"--tor\");\n  }\n\n  if (options.dnsPort) {\n    args.push(\"--dns-port\", options.dnsPort.toString());\n  }\n\n  if (options.torPort) {\n    args.push(\"--tor-port\", options.torPort.toString());\n  }\n\n  if (options.https) {\n    args.push(\"--https\");\n    if (options.httpsPort) {\n      args.push(\"--https-port\", options.httpsPort.toString());\n    }\n  }\n\n  console.log(\"üöÄ Starting tunnel daemon...\");\n  console.log(`Command: ${TUNNEL_DAEMON_PATH} ${args.join(\" \")}`);\n\n  // Spawn the daemon\n  const daemon = spawn(TUNNEL_DAEMON_PATH, args, {\n    stdio: [\"inherit\", \"inherit\", \"inherit\"],\n    env: {\n      ...process.env,\n      RUST_LOG: options.verbose ? \"debug\" : \"info\"\n    }\n  });\n\n  // Handle daemon exit\n  daemon.on(\"close\", (code) => {\n    if (code !== 0) {\n      console.error(`‚ùå Tunnel daemon exited with code ${code}`);\n      process.exit(code || 1);\n    }\n  });\n\n  daemon.on(\"error\", (error: any) => {\n    console.error(\"‚ùå Failed to start tunnel daemon:\", error.message);\n    console.log(\"üí° Try running: cargo build --release in packages/tunnel-daemon/\");\n    process.exit(1);\n  });\n\n  // Wait for daemon to initialize\n  await new Promise(resolve => setTimeout(resolve, 2000));\n\n  // Handle shutdown\n  process.on(\"SIGINT\", () => {\n    console.log(\"\\nüõë Shutting down...\");\n    daemon.kill(\"SIGTERM\");\n    process.exit(0);\n  });\n\n  process.on(\"SIGTERM\", () => {\n    console.log(\"\\nüõë Shutting down...\");\n    daemon.kill(\"SIGTERM\");\n    process.exit(0);\n  });\n}\n\nconst program = new Command();\n\nprogram\n  .name(\"beam\")\n  .description(\"Beam - Decentralized tunneling for developers\")\n  .version(\"2.0.0\");\n\nprogram\n  .command(\"login\")\n  .requiredOption(\"--token <token>\", \"CLI token issued from the dashboard\")\n  .description(\"Authenticate with a personal access token\")\n  .action((opts) => {\n    saveToken(opts.token);\n    console.log(\"‚úÖ Token saved\");\n  });\n\nprogram\n  .command(\"start\")\n  .description(\"Start a tunnel (default command)\")\n  .argument(\"<port>\", \"Local port to expose\", (v) => parseInt(v, 10))\n  .option(\"-d, --domain <name>\", \"Domain name to use\", `beam-${Date.now()}.local`)\n  .option(\"--dual\", \"Enable dual-mode (local + Tor)\")\n    .option(\"--tor\", \"Enable Tor-only mode\")\n    .option(\"--dns-port <port>\", \"DNS server port\", \"5353\")\n    .option(\"--tor-port <port>\", \"Tor control port\", \"9051\")\n    .option(\"--https\", \"Enable HTTPS with self-signed certificate\")\n    .option(\"--https-port <port>\", \"HTTPS port (defaults to HTTP port + 1)\")\n    .option(\"-v, --verbose\", \"Enable verbose logging\")\n    .action(async (port: number, options) => {\n    try {\n      await startTunnelDaemon(port, options);\n    } catch (error: any) {\n      console.error(\"‚ùå Failed to start tunnel:\", error.message);\n      process.exit(1);\n    }\n  });\n\n// Default command (no subcommand) - register options on main program\nprogram\n  .option(\"-d, --domain <name>\", \"Domain name to use\")\n  .option(\"--dual\", \"Enable dual-mode (local + Tor)\")\n  .option(\"--tor\", \"Enable Tor-only mode\")\n  .option(\"--dns-port <port>\", \"DNS server port\", \"5353\")\n  .option(\"--tor-port <port>\", \"Tor control port\", \"9051\")\n  .option(\"--https\", \"Enable HTTPS with self-signed certificate\")\n  .option(\"--https-port <port>\", \"HTTPS port (defaults to HTTP port + 1)\")\n  .option(\"-v, --verbose\", \"Enable verbose logging\")\n  .action(async (cmdOptions, command) => {\n    // If no port provided, show help\n    const args = command.args;\n    if (args.length === 0 || args[0].startsWith('-')) {\n      program.help();\n      return;\n    }\n\n    // Parse port from first argument\n    const port = parseInt(args[0], 10);\n    if (isNaN(port)) {\n      console.error(\"‚ùå Invalid port number\");\n      process.exit(1);\n    }\n\n    // Use options from the command\n    const options = {\n      domain: cmdOptions.domain || `beam-${Date.now()}.local`,\n      dual: cmdOptions.dual || false,\n      tor: cmdOptions.tor || false,\n      dnsPort: cmdOptions.dnsPort ? parseInt(cmdOptions.dnsPort, 10) : undefined,\n      torPort: cmdOptions.torPort ? parseInt(cmdOptions.torPort, 10) : undefined,\n      https: cmdOptions.https || false,\n      httpsPort: cmdOptions.httpsPort ? parseInt(cmdOptions.httpsPort, 10) : undefined,\n      verbose: cmdOptions.verbose || false,\n    };\n\n    try {\n      await startTunnelDaemon(port, options);\n    } catch (error: any) {\n      console.error(\"‚ùå Failed to start tunnel:\", error.message);\n      process.exit(1);\n    }\n  });\n\nprogram.parse();\n"],"mappings":"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","names":["path","os","fs","fs","path"]}
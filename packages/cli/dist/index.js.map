{"version":3,"sources":["../src/index.ts","../src/transport/tunnel.ts","../../../convex/_generated/api.js"],"sourcesContent":["#!/usr/bin/env node\nimport { Command } from \"commander\";\nimport fs from \"fs\";\nimport os from \"os\";\nimport path from \"path\";\nimport { startTunnel } from \"./transport/tunnel\";\n\nconst CONFIG_DIR = path.join(os.homedir(), \".beam\");\nconst CONFIG_PATH = path.join(CONFIG_DIR, \"credentials.json\");\n\nfunction saveToken(token: string) {\n  fs.mkdirSync(CONFIG_DIR, { recursive: true });\n  fs.writeFileSync(CONFIG_PATH, JSON.stringify({ token }, null, 2));\n  console.log(`Saved token to ${CONFIG_PATH}`);\n}\n\nfunction loadToken(): string | null {\n  if (!fs.existsSync(CONFIG_PATH)) return null;\n  try {\n    const data = JSON.parse(fs.readFileSync(CONFIG_PATH, \"utf8\"));\n    return data.token || null;\n  } catch {\n    return null;\n  }\n}\n\nconst program = new Command();\n\nprogram\n  .name(\"beam\")\n  .description(\"Beam CLI\")\n  .version(\"0.1.0\");\n\nprogram\n  .command(\"login\")\n  .requiredOption(\"--token <token>\", \"CLI token issued from the dashboard\")\n  .description(\"Authenticate with a personal access token\")\n  .action((opts) => {\n    saveToken(opts.token);\n  });\n\nprogram\n  .command(\"start\")\n  .argument(\"<port>\", \"Local port to expose\", (v) => parseInt(v, 10))\n  .requiredOption(\"--subdomain <name>\", \"Subdomain to use\")\n  .description(\"Start a tunnel\")\n  .action(async (port: number, opts) => {\n    const token = loadToken();\n    if (!token) {\n      console.error(\"No CLI token found. Run `beam login --token <token>` first.\");\n      process.exit(1);\n    }\n    await startTunnel(port, opts.subdomain, token);\n  });\n\nprogram.parse(process.argv);\n","import { ConvexHttpClient } from \"convex/browser\";\nimport { api } from \"../../../../convex/_generated/api\";\nimport * as Ably from \"ably\";\nimport http from \"http\";\n\nexport async function startTunnel(port: number, subdomain: string, cliToken: string) {\n  console.log(\"âš¡ Authenticating...\");\n\n  const convexUrl = process.env.CONVEX_URL || process.env.NEXT_PUBLIC_CONVEX_URL || \"\";\n  if (!convexUrl) {\n    throw new Error(\"CONVEX_URL (or NEXT_PUBLIC_CONVEX_URL) is not set\");\n  }\n\n  const convex = new ConvexHttpClient(convexUrl);\n\n  await convex.mutation(api.tunnels.upsertByApiKey, {\n    token: cliToken,\n    subdomain,\n    status: \"online\",\n    config: {},\n  });\n\n  const ablyTokenRequest = await convex.action(api.ably.generateTokenForCli, {\n    token: cliToken,\n    subdomain,\n  });\n\n  console.log(`ðŸŸ¢ Online at https://${subdomain}.beam.byronwade.com`);\n\n  const realtime = new Ably.Realtime({\n    tokenDetails: ablyTokenRequest as Ably.Types.TokenDetails,\n    useBinaryProtocol: true,\n  });\n\n  const reqChannel = realtime.channels.get(`tunnel:${subdomain}:req`);\n\n  await reqChannel.subscribe(\"request\", async (msg) => {\n    const { id, method, path, headers, body } = msg.data as {\n      id: string;\n      method: string;\n      path: string;\n      headers: Record<string, string>;\n      body?: string;\n    };\n\n    const req = http.request(\n      {\n        hostname: \"localhost\",\n        port,\n        path,\n        method,\n        headers: { ...headers, host: `localhost:${port}` },\n      },\n      (res) => {\n        const resChannel = realtime.channels.get(`tunnel:${subdomain}:res:${id}`);\n\n        resChannel.publish(\"meta\", { status: res.statusCode, headers: res.headers });\n        res.on(\"data\", (chunk) => resChannel.publish(\"chunk\", chunk));\n        res.on(\"end\", () => resChannel.publish(\"end\", null));\n      }\n    );\n\n    if (body) req.write(body);\n    req.end();\n  });\n}\n\n\n\n\n\n","/* eslint-disable */\n/**\n * Generated `api` utility.\n *\n * THIS CODE IS AUTOMATICALLY GENERATED.\n *\n * To regenerate, run `npx convex dev`.\n * @module\n */\n\nimport { anyApi, componentsGeneric } from \"convex/server\";\n\n/**\n * A utility for referencing Convex functions in your app's API.\n *\n * Usage:\n * ```js\n * const myFunctionReference = api.myModule.myFunction;\n * ```\n */\nexport const api = anyApi;\nexport const internal = anyApi;\nexport const components = componentsGeneric();\n"],"mappings":"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","names":["path"]}